<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
      <style type="text/css">

      </style>

    <script type="text/javascript">
      
      /* Function that takes a single argument, geo_data, 
      named so because it will be passed geojson file 
      -- OGR can be used to generate GEOjson files http://ogre.adc4gis.com/ -- */
      function draw(geo_data) {
        "use strict";
        /* Setup margins for chart */
        var margin = 75,
          width = 1920 - margin,
          height = 1080 - margin;

        /* Append and svg element to page 
        */
        var svg = d3.select("body")
        .append("svg")
        /* set margins */
        .attr("width", width + margin)
        .attr("height", height + margin)
        /* append container element to group related elements together (not d3 specific)*/
        .append('g')
        .attr('class', 'map');

        /* Setup mercator projection -- similar to d3 scales, given coordinates (lat, long) it returns pixel domain */
        var projection = d3.geo.mercator()
                              /* Scale = Zoom buttons, translate = dragging center of the map */
                               .scale(220)
                               .translate([width/2, height/1.5]);

        /* Construct svg object to correctly render pixels from mercator projection */
        var path = d3.geo.path().projection(projection);

        /* Put all the pieces together to actually draw data -- Select all paths and bind the geojson data
        to empty selection. */
        var map = svg.selectAll('path')
        /* Features is a key corresponds to array of country coordinates */
               .data(geo_data.features)
               /* Enter selection selects all the paths of countries (which are currently just placeholders) and for each appends a path */
               .enter()
               .append('path')
               /* d = data of the path, path returns funtion (since no parenthesis used) */
               .attr('d', path)
               .style('fill', 'rgb(9,157,217)')
               .style('stroke','black')
               .style('stroke-width', 0.5);

        function plot_points(data) {
            /* draw circles */

            /* Group data using d3 nest() function */
            var nested = d3.nest()
                            /* key() specifies how to group data, returns value that nest groups by */
                           .key(function(d) {
                              return d['date'].getUTCFullYear();
                           })
                           /* rollup() is passed a nested and hierarchical set of data organized (aggregation) */
                           .rollup(function(leaves){
                              /* d3.sum() takes in array or list like object, and accessor function that defines what to sum */

                              /* Sum of attendance */
                              var total = d3.sum(leaves, function(d) {
                                return d['attendance'];
                              });

                              /* Longitute data and latitude */
                              var coords = leaves.map(function(d) {
                                return projection([+d.long, +d.lat])
                              });

                              /* Compute mean latitude and longitude for x */
                              var center_x = d3.mean(coords, function(d) {
                                return d[0];
                              });

                              /* Compute mean latitude and longitude for y */
                              var center_y = d3.mean(coords, function(d) {
                                return d[1];
                              });

                              return {
                                'attendance' : total,
                                'x' : center_x,
                                'y' : center_y
                              };
                           })
                           .entries(data);


                              debugger;
            
        };

        var format = d3.time.format("%d-%m-%Y (%H:%M h)");

        /* Data transform funtion to convert attendance to integer, and date to a javascript date type */
        d3.tsv("world_cup_geo.tsv", function(d) {
          d['attendance'] = +d['attendance'];
          d['date'] = format.parse(d['date']);
          return d;
        }, plot_points);

      };
    </script>
  </head>

  <body>
    <script type="text/javascript">

      d3.json("world_countries.json", draw);
    </script>

  </body>
</html>